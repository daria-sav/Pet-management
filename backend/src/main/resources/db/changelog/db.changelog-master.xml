<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.31.xsd">
    
    <!-- ===== ChangeSet #1: base tables ===== -->
    <changeSet id="1-create-tables" author="daria">

        <!-- country(id, name) -->
        <createTable tableName="country">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="pk_country"/>
            </column>
            <column name="name" type="VARCHAR(100)">
                <constraints nullable= "false"/>
            </column>
        </createTable>

        <!-- pet_type(id, name UNIQUE) -->
        <createTable tableName="pet_type">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="pk_pet_type"/>
            </column>
            <column name="code" type="VARCHAR(32)">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- users(id, username UNIQUE, password_hash, created_at) -->
        <createTable tableName="users">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="pk_users"/>
            </column>
            <column name="username" type="VARCHAR(100)">
                <constraints nullable= "false"/>
            </column>
            <column name="password_hash" type="VARCHAR(255)">
                <constraints nullable= "false"/>
            </column>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- pets(id, name, identification_number UNIQUE, type_id FK, fur_color, country_id FK NULL, owner_id FK) -->
        <createTable tableName="pets">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="pk_pets"/>
            </column>
            <column name="name" type="VARCHAR(100)">
                <constraints nullable= "false"/>
            </column>
            <column name="identification_number" type="VARCHAR(64)">
                <constraints nullable="false"/>
            </column>
            <column name="type_id" type="BIGINT">
                <constraints nullable= "false"/>
            </column>
            <column name="fur_color" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="country_id" type="BIGINT"/>
            <column name="owner_id" type="BIGINT">
                <constraints nullable= "false"/>
            </column>
        </createTable>

        <!-- Unique Constraints -->
        <addUniqueConstraint tableName="country" columnNames="name" constraintName="uk_country_iso2"/>
        <addUniqueConstraint tableName="pet_type" columnNames="code" constraintName="uk_pet_type_code"/>
        <addUniqueConstraint tableName="users" columnNames="username" constraintName="uk_users_username"/>
        <addUniqueConstraint tableName="pets" columnNames="identification_number" constraintName="uk_pets_identification_number"/>

        <!-- Foreign keys for pets -->
        <addForeignKeyConstraint
                baseTableName="pets" baseColumnNames="type_id"
                referencedTableName="pet_type" referencedColumnNames="id"
                constraintName="fk_pets_type" onDelete="RESTRICT" onUpdate="CASCADE"/>

        <addForeignKeyConstraint
                baseTableName="pets" baseColumnNames="country_id"
                referencedTableName="country" referencedColumnNames="id"
                constraintName="fk_pets_country" onDelete="SET NULL" onUpdate="CASCADE"/>

        <addForeignKeyConstraint
                baseTableName="pets" baseColumnNames="owner_id"
                referencedTableName="users" referencedColumnNames="id"
                constraintName="fk_pets_owner" onDelete="CASCADE" onUpdate="CASCADE"/>

        <!-- Useful indexes -->
        <createIndex tableName="pets" indexName="idx_pets_owner_id">
            <column name="owner_id"/>
        </createIndex>
        <createIndex tableName="pets" indexName="idx_pets_type_id">
            <column name="type_id"/>
        </createIndex>
        <createIndex tableName="pets" indexName="idx_pets_country_id">
            <column name="country_id"/>
        </createIndex>
   </changeSet>

   <changeSet id="2-seed-lookups" author="daria" context="prod">
        <insert tableName="pet_type">
            <column name="code" value="CAT"/>
            <column name="name" value="Cat"/>
        </insert>
        <insert tableName="pet_type">
            <column name="code" value="DOG"/>
            <column name="name" value="Dog"/>
        </insert>
        <insert tableName="country">
            <column name="name" value="Estonia"/>
        </insert>
        <insert tableName="country">
            <column name="name" value="Latvia"/>
        </insert>
    </changeSet>

    <changeSet id="3-seed-users" author="daria" context="prod">
        <insert tableName="users">
            <column name="username" value="alice"/>
            <column name="password_hash" value="$2a$12$otlsV/6JDP3REsmPaNm6U.kSG6L34wD.dYkDyqrGrntutL1GcgWpu"/>
        </insert>

        <insert tableName="users">
            <column name="username" value="user"/>
            <column name="password_hash" value="$2a$12$1f0Jc3.rSUTMQoduxBL7beOVMngFG9He7l/bcEM/p.oABvkLWMvDW"/>
        </insert>

        <insert tableName="users">
            <column name="username" value="carol"/>
            <column name="password_hash" value="$2a$12$NP0EqxC8gD9uiwf0MQXMNuf7ZELlX/uBs6dwhEfeARpmcbpDEtsi."/>
        </insert>
    </changeSet>

    <!-- ===== ChangeSet #4: add pet type OTHER ===== -->
    <changeSet id="4-add-pet-type-other" author="daria" context="prod">
        <insert tableName="pet_type">
            <column name="code" value="OTHER"/>
            <column name="name" value="Other"/>
        </insert>
    </changeSet>

    <!-- ===== ChangeSet #5: DB CHECK constraints for pets ===== -->
    <changeSet id="5-pets-check-constraints" author="daria" context="prod">

        <sql>ALTER TABLE pets ADD CONSTRAINT chk_pets_ident_num_digits CHECK (identification_number ~ '^[0-9]{1,12}$');</sql>
        <sql>ALTER TABLE pets ADD CONSTRAINT chk_pets_name_pattern CHECK (name ~ '^[[:alnum:] _()]+$');</sql>
        <sql>ALTER TABLE pets ADD CONSTRAINT chk_pets_fur_color_letters CHECK (fur_color ~ '^[[:alpha:] ]+$');</sql>
        <rollback>
            <sql>ALTER TABLE pets DROP CONSTRAINT IF EXISTS chk_pets_ident_num_digits;</sql>
            <sql>ALTER TABLE pets DROP CONSTRAINT IF EXISTS chk_pets_name_pattern;</sql>
            <sql>ALTER TABLE pets DROP CONSTRAINT IF EXISTS chk_pets_fur_color_letters;</sql>
        </rollback>
    </changeSet>

    <!-- ===== ChangeSet #6: soft delete for pets ===== -->
    <changeSet id="6-pets-add-active" author="daria" context="prod">
        <addColumn tableName="pets">
            <column name="active" type="BOOLEAN" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <update tableName="pets">
            <column name="active" valueBoolean="true"/>
        </update>

        <rollback>
            <dropColumn tableName="pets" columnName="active"/>
        </rollback>
    </changeSet>

</databaseChangeLog>